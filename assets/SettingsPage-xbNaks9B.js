import{f as x,u as w,s as d,_ as A,r as f,c as y,e as _,a as b,b as l,d as m,t as g,h as q,C as I,i as P,x as V,y as B,q as D}from"./index-CpXpfZ6u.js";import{_ as F}from"./DisplayAvatar-DT18U7jm.js";import{u as z}from"./errors-DO3E_Mwy.js";const $=x("changeUser ",()=>{const a=z(),o=w(),v=async e=>{const{error:r}=await d.from("users").update({avatar_url:e}).eq("id",o.user.id);if(o.user.avatar_url=e,r)throw new Error("Ошибка при обновлении URL аватара: "+r.message)},t=async(e,r)=>{try{const{data:s,error:i}=await d.from("users").update({birthdate:r}).eq("id",e);if(i)throw i;return s}catch(s){throw console.error("Ошибка при изменении даты рождения:",s),s}},n=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?!0:(a.setErrors("Введите корректный адрес электронной почты."),!1);return{changeUsername:async e=>{try{const r=o.user.username,{data:s,error:i}=await d.from("users").update({username:e}).eq("id",o.user.id);if(i)throw i;const{error:c}=await d.from("posts").update({username:e}).eq("user_id",o.user.id);if(c)throw c;o.user.username=e,a.clearErrors()}catch(r){a.setErrors(r.message||"Ошибка при изменении имени"),console.error("Ошибка:",r)}},changeEmail:async(e,r)=>{if(!n(r))return;const{error:s}=await d.auth.updateUser({email:r});if(s){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",s);return}const{error:i}=await d.from("users").update({email:r}).eq("email",e).select();if(i){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",i);return}a.clearErrors()},updateAvatarUrl:v,changeBirthdate:t}}),T={__name:"AvatarUploader",props:{size:{type:Number,default:12}},setup(a){const o=w(),v=$(),t=f(null),n=y(()=>o.user.id),p=y(()=>o.avatar_url),u=f(null),e=()=>{t.value.click()},r=async c=>{u.value=c.target.files[0],u.value&&await i()},s=a,i=async()=>{try{if(!u.value)return;if(p.value){const C=`avatars/${n.value}/${p.value.split("/").pop()}`,{error:S}=await d.storage.from("avatars").remove([C]);if(S)throw S}const c=`avatars/${n.value}/${u.value.name}`,{data:h,error:E}=await d.storage.from("avatars").upload(c,u.value,{upsert:!0});if(E)throw E;const k=`https://kawdmbqsvrrmvhymflnx.supabase.co/storage/v1/object/public/avatars/${h.path}`;await v.updateAvatarUrl(k),t.value.value="",u.value=null}catch(c){console.error("Ошибка загрузки аватара:",c)}};return(c,h)=>(_(),b("div",null,[l("div",{onClick:e,class:"avatar-wrapper"},[m(F,{size:s.size},null,8,["size"]),h[0]||(h[0]=l("div",{class:"hover-overlay"},[l("svg",{class:"camera-icon",viewBox:"0 0 24 24"},[l("path",{fill:"currentColor",d:"M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"})])],-1)),l("input",{type:"file",ref_key:"fileInput",ref:t,onChange:r,accept:"image/*",class:"hidden-input"},null,544)])]))}},H=A(T,[["__scopeId","data-v-0dcd58ab"]]),M={key:0},N=["type","name"],L={__name:"EditableField",props:{label:String,value:String,inputType:String,name:String,error:String},emits:["save"],setup(a,{emit:o}){const v=o,t=f(!1),n=f(""),p=()=>{v("save",n.value),t.value=!1,n.value=""};return(u,e)=>(_(),b("div",null,[l("p",null,g(a.label)+": "+g(a.value?a.value:"Неизвестно"),1),l("button",{onClick:e[0]||(e[0]=r=>t.value=!t.value)},g(a.value?"Изменить":"Добавить"),1),t.value?(_(),b("div",M,[q(l("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>n.value=r),type:a.inputType,name:a.name},null,8,N),[[I,n.value]]),l("button",{onClick:p},"Сохранить")])):P("",!0),l("pre",null,g(a.error),1)]))}},U=A(L,[["__scopeId","data-v-577e7412"]]),j={class:"setting"},O={__name:"SettingsPage",setup(a){const o=w(),v=$(),t=y(()=>o.user||{}),n=f(""),p=y(()=>t.value.birthdate?new Date(t.value.birthdate).toISOString().split("T")[0]:"");return(u,e)=>{const r=D("router-link");return _(),b("section",j,[m(r,{to:`/profile/${t.value.username}`},{default:V(()=>e[2]||(e[2]=[l("span",{class:"material-icons"},"назад в профиль",-1)])),_:1},8,["to"]),m(H,{size:50}),m(U,{label:"Никнейм",value:t.value.username,inputType:"text",name:"username",error:n.value,onSave:e[0]||(e[0]=s=>B(v).changeUsername(s))},null,8,["value","error"]),m(U,{label:"Дата рождения",value:p.value,inputType:"date",name:"birthdate",error:n.value,onSave:e[1]||(e[1]=s=>u.updateProfileField("birthdate",s))},null,8,["value","error"])])}}},J=A(O,[["__scopeId","data-v-84fdc0ba"]]);export{J as default};
