import{f as B,u as w,s as d,_ as A,r as f,c as _,e as y,a as b,b as l,d as m,t as g,h as D,D as I,i as V,y as q,z as U,x as z}from"./index-Ck_nBHmI.js";import{_ as P}from"./DisplayAvatar-CtYGHtwB.js";import{u as F}from"./errors-DxTY0Z__.js";const k=B("changeUser ",()=>{const a=F(),s=w(),c=async e=>{const{error:r}=await d.from("users").update({avatar_url:e}).eq("id",s.user.id);if(s.user.avatar_url=e,r)throw new Error("Ошибка при обновлении URL аватара: "+r.message)},t=async e=>{try{const{data:r,error:n}=await d.from("users").update({birthdate:e}).eq("id",s.user.id);if(n)throw n;return r}catch(r){throw console.error("Ошибка при изменении даты рождения:",r),r}},o=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?!0:(a.setErrors("Введите корректный адрес электронной почты."),!1);return{changeUsername:async e=>{try{const r=s.user.username,{data:n,error:p}=await d.from("users").update({username:e}).eq("id",s.user.id);if(p)throw p;const{error:i}=await d.from("posts").update({username:e}).eq("user_id",s.user.id);if(i)throw i;s.user.username=e,a.clearErrors()}catch(r){a.setErrors(r.message||"Ошибка при изменении имени"),console.error("Ошибка:",r)}},changeEmail:async(e,r)=>{if(!o(r))return;const{error:n}=await d.auth.updateUser({email:r});if(n){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",n);return}const{error:p}=await d.from("users").update({email:r}).eq("email",e).select();if(p){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",p);return}a.clearErrors()},updateAvatarUrl:c,changeBirthdate:t}}),T={__name:"AvatarUploader",props:{size:{type:Number,default:12}},setup(a){const s=w(),c=k(),t=f(null),o=_(()=>s.user.id),v=_(()=>s.avatar_url),u=f(null),e=()=>{t.value.click()},r=async i=>{u.value=i.target.files[0],u.value&&await p()},n=a,p=async()=>{try{if(!u.value)return;if(v.value){const C=`avatars/${o.value}/${v.value.split("/").pop()}`,{error:S}=await d.storage.from("avatars").remove([C]);if(S)throw S}const i=`avatars/${o.value}/${u.value.name}`,{data:h,error:E}=await d.storage.from("avatars").upload(i,u.value,{upsert:!0});if(E)throw E;const x=`https://kawdmbqsvrrmvhymflnx.supabase.co/storage/v1/object/public/avatars/${h.path}`;await c.updateAvatarUrl(x),t.value.value="",u.value=null}catch(i){console.error("Ошибка загрузки аватара:",i)}};return(i,h)=>(y(),b("div",null,[l("div",{onClick:e,class:"avatar-wrapper"},[m(P,{size:n.size},null,8,["size"]),h[0]||(h[0]=l("div",{class:"hover-overlay"},[l("svg",{class:"camera-icon",viewBox:"0 0 24 24"},[l("path",{fill:"currentColor",d:"M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"})])],-1)),l("input",{type:"file",ref_key:"fileInput",ref:t,onChange:r,accept:"image/*",class:"hidden-input"},null,544)])]))}},H=A(T,[["__scopeId","data-v-76c17073"]]),M={key:0},N=["type","name"],L={__name:"EditableField",props:{label:String,value:String,inputType:String,name:String,error:String},emits:["save"],setup(a,{emit:s}){const c=s,t=f(!1),o=f(""),v=()=>{c("save",o.value),t.value=!1,o.value=""};return(u,e)=>(y(),b("div",null,[l("p",null,g(a.label)+": "+g(a.value?a.value:"Неизвестно"),1),l("button",{onClick:e[0]||(e[0]=r=>t.value=!t.value)},g(a.value?"Изменить":"Добавить"),1),t.value?(y(),b("div",M,[D(l("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>o.value=r),type:a.inputType,name:a.name},null,8,N),[[I,o.value]]),l("button",{onClick:v},"Сохранить")])):V("",!0),l("pre",null,g(a.error),1)]))}},$=A(L,[["__scopeId","data-v-dacfbfbd"]]),j={class:"setting"},O={__name:"SettingsPage",setup(a){const s=w(),c=k(),t=_(()=>s.user||{}),o=f(""),v=_(()=>t.value.birthdate?new Date(t.value.birthdate).toISOString().split("T")[0]:"");return(u,e)=>{const r=z("router-link");return y(),b("section",j,[m(r,{to:`/profile/${t.value.username}`},{default:q(()=>e[2]||(e[2]=[l("span",{class:"material-icons"},"назад в профиль",-1)])),_:1},8,["to"]),m(H,{size:50}),m($,{label:"Никнейм",value:t.value.username,inputType:"text",name:"username",error:o.value,onSave:e[0]||(e[0]=n=>U(c).changeUsername(n))},null,8,["value","error"]),m($,{label:"Дата рождения",value:v.value,inputType:"date",name:"birthdate",error:o.value,onSave:e[1]||(e[1]=n=>U(c).changeBirthdate(n))},null,8,["value","error"])])}}},J=A(O,[["__scopeId","data-v-b9d94dc9"]]);export{J as default};
