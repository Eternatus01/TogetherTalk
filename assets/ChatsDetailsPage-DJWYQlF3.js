import{G as fe,_ as me,r as V,e as A,a as P,b as F,d as ce,t as oe,i as le,H as De,F as Te,j as Oe,p as he,s as B,u as Ce,c as ve,I as xe,w as Ie,o as ke,J as je,y as ge,K as Ee,L as Ue}from"./index-Dy3JlB_K.js";import{A as He}from"./Avatar-emXoMLdg.js";var re={exports:{}},ze=re.exports,$e;function Le(){return $e||($e=1,function(r,M){(function(S,c){r.exports=c()})(ze,function(){var S=1e3,c=6e4,a=36e5,j="millisecond",$="second",h="minute",o="hour",w="day",D="week",u="month",d="quarter",v="year",p="date",i="Invalid Date",y=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,C=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,I={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(l){var e=["th","st","nd","rd"],t=l%100;return"["+l+(e[(t-20)%10]||e[t]||e[0])+"]"}},_=function(l,e,t){var n=String(l);return!n||n.length>=e?l:""+Array(e+1-n.length).join(t)+l},H={s:_,z:function(l){var e=-l.utcOffset(),t=Math.abs(e),n=Math.floor(t/60),s=t%60;return(e<=0?"+":"-")+_(n,2,"0")+":"+_(s,2,"0")},m:function l(e,t){if(e.date()<t.date())return-l(t,e);var n=12*(t.year()-e.year())+(t.month()-e.month()),s=e.clone().add(n,u),f=t-s<0,m=e.clone().add(n+(f?-1:1),u);return+(-(n+(t-s)/(f?s-m:m-s))||0)},a:function(l){return l<0?Math.ceil(l)||0:Math.floor(l)},p:function(l){return{M:u,y:v,w:D,d:w,D:p,h:o,m:h,s:$,ms:j,Q:d}[l]||String(l||"").toLowerCase().replace(/s$/,"")},u:function(l){return l===void 0}},x="en",g={};g[x]=I;var k="$isDayjsObject",U=function(l){return l instanceof q||!(!l||!l[k])},z=function l(e,t,n){var s;if(!e)return x;if(typeof e=="string"){var f=e.toLowerCase();g[f]&&(s=f),t&&(g[f]=t,s=f);var m=e.split("-");if(!s&&m.length>1)return l(m[0])}else{var T=e.name;g[T]=e,s=T}return!n&&s&&(x=s),s||!n&&x},O=function(l,e){if(U(l))return l.clone();var t=typeof e=="object"?e:{};return t.date=l,t.args=arguments,new q(t)},b=H;b.l=z,b.i=U,b.w=function(l,e){return O(l,{locale:e.$L,utc:e.$u,x:e.$x,$offset:e.$offset})};var q=function(){function l(t){this.$L=z(t.locale,null,!0),this.parse(t),this.$x=this.$x||t.x||{},this[k]=!0}var e=l.prototype;return e.parse=function(t){this.$d=function(n){var s=n.date,f=n.utc;if(s===null)return new Date(NaN);if(b.u(s))return new Date;if(s instanceof Date)return new Date(s);if(typeof s=="string"&&!/Z$/i.test(s)){var m=s.match(y);if(m){var T=m[2]-1||0,E=(m[7]||"0").substring(0,3);return f?new Date(Date.UTC(m[1],T,m[3]||1,m[4]||0,m[5]||0,m[6]||0,E)):new Date(m[1],T,m[3]||1,m[4]||0,m[5]||0,m[6]||0,E)}}return new Date(s)}(t),this.init()},e.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},e.$utils=function(){return b},e.isValid=function(){return this.$d.toString()!==i},e.isSame=function(t,n){var s=O(t);return this.startOf(n)<=s&&s<=this.endOf(n)},e.isAfter=function(t,n){return O(t)<this.startOf(n)},e.isBefore=function(t,n){return this.endOf(n)<O(t)},e.$g=function(t,n,s){return b.u(t)?this[n]:this.set(s,t)},e.unix=function(){return Math.floor(this.valueOf()/1e3)},e.valueOf=function(){return this.$d.getTime()},e.startOf=function(t,n){var s=this,f=!!b.u(n)||n,m=b.p(t),T=function(J,N){var R=b.w(s.$u?Date.UTC(s.$y,N,J):new Date(s.$y,N,J),s);return f?R:R.endOf(w)},E=function(J,N){return b.w(s.toDate()[J].apply(s.toDate("s"),(f?[0,0,0,0]:[23,59,59,999]).slice(N)),s)},L=this.$W,Y=this.$M,W=this.$D,K="set"+(this.$u?"UTC":"");switch(m){case v:return f?T(1,0):T(31,11);case u:return f?T(1,Y):T(0,Y+1);case D:var Z=this.$locale().weekStart||0,Q=(L<Z?L+7:L)-Z;return T(f?W-Q:W+(6-Q),Y);case w:case p:return E(K+"Hours",0);case o:return E(K+"Minutes",1);case h:return E(K+"Seconds",2);case $:return E(K+"Milliseconds",3);default:return this.clone()}},e.endOf=function(t){return this.startOf(t,!1)},e.$set=function(t,n){var s,f=b.p(t),m="set"+(this.$u?"UTC":""),T=(s={},s[w]=m+"Date",s[p]=m+"Date",s[u]=m+"Month",s[v]=m+"FullYear",s[o]=m+"Hours",s[h]=m+"Minutes",s[$]=m+"Seconds",s[j]=m+"Milliseconds",s)[f],E=f===w?this.$D+(n-this.$W):n;if(f===u||f===v){var L=this.clone().set(p,1);L.$d[T](E),L.init(),this.$d=L.set(p,Math.min(this.$D,L.daysInMonth())).$d}else T&&this.$d[T](E);return this.init(),this},e.set=function(t,n){return this.clone().$set(t,n)},e.get=function(t){return this[b.p(t)]()},e.add=function(t,n){var s,f=this;t=Number(t);var m=b.p(n),T=function(Y){var W=O(f);return b.w(W.date(W.date()+Math.round(Y*t)),f)};if(m===u)return this.set(u,this.$M+t);if(m===v)return this.set(v,this.$y+t);if(m===w)return T(1);if(m===D)return T(7);var E=(s={},s[h]=c,s[o]=a,s[$]=S,s)[m]||1,L=this.$d.getTime()+t*E;return b.w(L,this)},e.subtract=function(t,n){return this.add(-1*t,n)},e.format=function(t){var n=this,s=this.$locale();if(!this.isValid())return s.invalidDate||i;var f=t||"YYYY-MM-DDTHH:mm:ssZ",m=b.z(this),T=this.$H,E=this.$m,L=this.$M,Y=s.weekdays,W=s.months,K=s.meridiem,Z=function(N,R,X,te){return N&&(N[R]||N(n,f))||X[R].slice(0,te)},Q=function(N){return b.s(T%12||12,N,"0")},J=K||function(N,R,X){var te=N<12?"AM":"PM";return X?te.toLowerCase():te};return f.replace(C,function(N,R){return R||function(X){switch(X){case"YY":return String(n.$y).slice(-2);case"YYYY":return b.s(n.$y,4,"0");case"M":return L+1;case"MM":return b.s(L+1,2,"0");case"MMM":return Z(s.monthsShort,L,W,3);case"MMMM":return Z(W,L);case"D":return n.$D;case"DD":return b.s(n.$D,2,"0");case"d":return String(n.$W);case"dd":return Z(s.weekdaysMin,n.$W,Y,2);case"ddd":return Z(s.weekdaysShort,n.$W,Y,3);case"dddd":return Y[n.$W];case"H":return String(T);case"HH":return b.s(T,2,"0");case"h":return Q(1);case"hh":return Q(2);case"a":return J(T,E,!0);case"A":return J(T,E,!1);case"m":return String(E);case"mm":return b.s(E,2,"0");case"s":return String(n.$s);case"ss":return b.s(n.$s,2,"0");case"SSS":return b.s(n.$ms,3,"0");case"Z":return m}return null}(N)||m.replace(":","")})},e.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},e.diff=function(t,n,s){var f,m=this,T=b.p(n),E=O(t),L=(E.utcOffset()-this.utcOffset())*c,Y=this-E,W=function(){return b.m(m,E)};switch(T){case v:f=W()/12;break;case u:f=W();break;case d:f=W()/3;break;case D:f=(Y-L)/6048e5;break;case w:f=(Y-L)/864e5;break;case o:f=Y/a;break;case h:f=Y/c;break;case $:f=Y/S;break;default:f=Y}return s?f:b.a(f)},e.daysInMonth=function(){return this.endOf(u).$D},e.$locale=function(){return g[this.$L]},e.locale=function(t,n){if(!t)return this.$L;var s=this.clone(),f=z(t,n,!0);return f&&(s.$L=f),s},e.clone=function(){return b.w(this.$d,this)},e.toDate=function(){return new Date(this.valueOf())},e.toJSON=function(){return this.isValid()?this.toISOString():null},e.toISOString=function(){return this.$d.toISOString()},e.toString=function(){return this.$d.toUTCString()},l}(),G=q.prototype;return O.prototype=G,[["$ms",j],["$s",$],["$m",h],["$H",o],["$W",w],["$M",u],["$y",v],["$D",p]].forEach(function(l){G[l[1]]=function(e){return this.$g(e,l[0],l[1])}}),O.extend=function(l,e){return l.$i||(l(e,q,O),l.$i=!0),O},O.locale=z,O.isDayjs=U,O.unix=function(l){return O(1e3*l)},O.en=g[x],O.Ls=g,O.p={},O})}(re)),re.exports}var Ye=Le();const ne=fe(Ye);var se={exports:{}},Ne=se.exports,pe;function Fe(){return pe||(pe=1,function(r,M){(function(S,c){r.exports=c()})(Ne,function(){var S="minute",c=/[+-]\d\d(?::?\d\d)?/g,a=/([+-]|\d\d)/g;return function(j,$,h){var o=$.prototype;h.utc=function(i){var y={date:i,utc:!0,args:arguments};return new $(y)},o.utc=function(i){var y=h(this.toDate(),{locale:this.$L,utc:!0});return i?y.add(this.utcOffset(),S):y},o.local=function(){return h(this.toDate(),{locale:this.$L,utc:!1})};var w=o.parse;o.parse=function(i){i.utc&&(this.$u=!0),this.$utils().u(i.$offset)||(this.$offset=i.$offset),w.call(this,i)};var D=o.init;o.init=function(){if(this.$u){var i=this.$d;this.$y=i.getUTCFullYear(),this.$M=i.getUTCMonth(),this.$D=i.getUTCDate(),this.$W=i.getUTCDay(),this.$H=i.getUTCHours(),this.$m=i.getUTCMinutes(),this.$s=i.getUTCSeconds(),this.$ms=i.getUTCMilliseconds()}else D.call(this)};var u=o.utcOffset;o.utcOffset=function(i,y){var C=this.$utils().u;if(C(i))return this.$u?0:C(this.$offset)?u.call(this):this.$offset;if(typeof i=="string"&&(i=function(x){x===void 0&&(x="");var g=x.match(c);if(!g)return null;var k=(""+g[0]).match(a)||["-",0,0],U=k[0],z=60*+k[1]+ +k[2];return z===0?0:U==="+"?z:-z}(i),i===null))return this;var I=Math.abs(i)<=16?60*i:i,_=this;if(y)return _.$offset=I,_.$u=i===0,_;if(i!==0){var H=this.$u?this.toDate().getTimezoneOffset():-1*this.utcOffset();(_=this.local().add(I+H,S)).$offset=I,_.$x.$localOffset=H}else _=this.utc();return _};var d=o.format;o.format=function(i){var y=i||(this.$u?"YYYY-MM-DDTHH:mm:ss[Z]":"");return d.call(this,y)},o.valueOf=function(){var i=this.$utils().u(this.$offset)?0:this.$offset+(this.$x.$localOffset||this.$d.getTimezoneOffset());return this.$d.valueOf()-6e4*i},o.isUTC=function(){return!!this.$u},o.toISOString=function(){return this.toDate().toISOString()},o.toString=function(){return this.toDate().toUTCString()};var v=o.toDate;o.toDate=function(i){return i==="s"&&this.$offset?h(this.format("YYYY-MM-DD HH:mm:ss:SSS")).toDate():v.call(this)};var p=o.diff;o.diff=function(i,y,C){if(i&&this.$u===i.$u)return p.call(this,i,y,C);var I=this.local(),_=h(i).local();return p.call(I,_,y,C)}}})}(se)),se.exports}var We=Fe();const Ve=fe(We);var ie={exports:{}},Ae=ie.exports,ye;function Pe(){return ye||(ye=1,function(r,M){(function(S,c){r.exports=c()})(Ae,function(){var S={year:0,month:1,day:2,hour:3,minute:4,second:5},c={};return function(a,j,$){var h,o=function(d,v,p){p===void 0&&(p={});var i=new Date(d),y=function(C,I){I===void 0&&(I={});var _=I.timeZoneName||"short",H=C+"|"+_,x=c[H];return x||(x=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:C,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",timeZoneName:_}),c[H]=x),x}(v,p);return y.formatToParts(i)},w=function(d,v){for(var p=o(d,v),i=[],y=0;y<p.length;y+=1){var C=p[y],I=C.type,_=C.value,H=S[I];H>=0&&(i[H]=parseInt(_,10))}var x=i[3],g=x===24?0:x,k=i[0]+"-"+i[1]+"-"+i[2]+" "+g+":"+i[4]+":"+i[5]+":000",U=+d;return($.utc(k).valueOf()-(U-=U%1e3))/6e4},D=j.prototype;D.tz=function(d,v){d===void 0&&(d=h);var p,i=this.utcOffset(),y=this.toDate(),C=y.toLocaleString("en-US",{timeZone:d}),I=Math.round((y-new Date(C))/1e3/60),_=15*-Math.round(y.getTimezoneOffset()/15)-I;if(!Number(_))p=this.utcOffset(0,v);else if(p=$(C,{locale:this.$L}).$set("millisecond",this.$ms).utcOffset(_,!0),v){var H=p.utcOffset();p=p.add(i-H,"minute")}return p.$x.$timezone=d,p},D.offsetName=function(d){var v=this.$x.$timezone||$.tz.guess(),p=o(this.valueOf(),v,{timeZoneName:d}).find(function(i){return i.type.toLowerCase()==="timezonename"});return p&&p.value};var u=D.startOf;D.startOf=function(d,v){if(!this.$x||!this.$x.$timezone)return u.call(this,d,v);var p=$(this.format("YYYY-MM-DD HH:mm:ss:SSS"),{locale:this.$L});return u.call(p,d,v).tz(this.$x.$timezone,!0)},$.tz=function(d,v,p){var i=p&&v,y=p||v||h,C=w(+$(),y);if(typeof d!="string")return $(d).tz(y);var I=function(g,k,U){var z=g-60*k*1e3,O=w(z,U);if(k===O)return[z,k];var b=w(z-=60*(O-k)*1e3,U);return O===b?[z,O]:[g-60*Math.min(O,b)*1e3,Math.max(O,b)]}($.utc(d,i).valueOf(),C,y),_=I[0],H=I[1],x=$(_).utcOffset(H);return x.$x.$timezone=y,x},$.tz.guess=function(){return Intl.DateTimeFormat().resolvedOptions().timeZone},$.tz.setDefault=function(d){h=d}}})}(ie)),ie.exports}var qe=Pe();const Be=fe(qe);var Re=typeof global=="object"&&global&&global.Object===Object&&global,Ze=typeof self=="object"&&self&&self.Object===Object&&self,we=Re||Ze||Function("return this")(),ae=we.Symbol,_e=Object.prototype,Je=_e.hasOwnProperty,Ke=_e.toString,ee=ae?ae.toStringTag:void 0;function Ge(r){var M=Je.call(r,ee),S=r[ee];try{r[ee]=void 0;var c=!0}catch{}var a=Ke.call(r);return c&&(M?r[ee]=S:delete r[ee]),a}var Qe=Object.prototype,Xe=Qe.toString;function et(r){return Xe.call(r)}var tt="[object Null]",nt="[object Undefined]",Se=ae?ae.toStringTag:void 0;function rt(r){return r==null?r===void 0?nt:tt:Se&&Se in Object(r)?Ge(r):et(r)}function st(r){return r!=null&&typeof r=="object"}var it="[object Symbol]";function at(r){return typeof r=="symbol"||st(r)&&rt(r)==it}var ot=/\s/;function ut(r){for(var M=r.length;M--&&ot.test(r.charAt(M)););return M}var ct=/^\s+/;function lt(r){return r&&r.slice(0,ut(r)+1).replace(ct,"")}function de(r){var M=typeof r;return r!=null&&(M=="object"||M=="function")}var be=NaN,dt=/^[-+]0x[0-9a-f]+$/i,ft=/^0b[01]+$/i,mt=/^0o[0-7]+$/i,ht=parseInt;function Me(r){if(typeof r=="number")return r;if(at(r))return be;if(de(r)){var M=typeof r.valueOf=="function"?r.valueOf():r;r=de(M)?M+"":M}if(typeof r!="string")return r===0?r:+r;r=lt(r);var S=ft.test(r);return S||mt.test(r)?ht(r.slice(2),S?2:8):dt.test(r)?be:+r}var ue=function(){return we.Date.now()},vt="Expected a function",gt=Math.max,$t=Math.min;function pt(r,M,S){var c,a,j,$,h,o,w=0,D=!1,u=!1,d=!0;if(typeof r!="function")throw new TypeError(vt);M=Me(M)||0,de(S)&&(D=!!S.leading,u="maxWait"in S,j=u?gt(Me(S.maxWait)||0,M):j,d="trailing"in S?!!S.trailing:d);function v(g){var k=c,U=a;return c=a=void 0,w=g,$=r.apply(U,k),$}function p(g){return w=g,h=setTimeout(C,M),D?v(g):$}function i(g){var k=g-o,U=g-w,z=M-k;return u?$t(z,j-U):z}function y(g){var k=g-o,U=g-w;return o===void 0||k>=M||k<0||u&&U>=j}function C(){var g=ue();if(y(g))return I(g);h=setTimeout(C,i(g))}function I(g){return h=void 0,d&&c?v(g):(c=a=void 0,$)}function _(){h!==void 0&&clearTimeout(h),w=0,c=o=a=h=void 0}function H(){return h===void 0?$:I(ue())}function x(){var g=ue(),k=y(g);if(c=arguments,a=this,o=g,k){if(h===void 0)return p(o);if(u)return clearTimeout(h),h=setTimeout(C,M),v(o)}return h===void 0&&(h=setTimeout(C,M)),$}return x.cancel=_,x.flush=H,x}const yt={class:"asda"},St={class:"message"},bt={class:"message-content"},Mt={key:0},Dt={key:1,class:"message-image"},wt=["src"],_t={__name:"MessageItem",props:{message:Object,username:String,avatar:String,isOwnMessage:Boolean},emits:["edit","delete"],setup(r,{emit:M}){return V(!1),(S,c)=>(A(),P("div",yt,[F("div",St,[ce(He,{username:r.username},null,8,["username"]),F("strong",null,oe(r.username||"Загрузка...")+":",1),F("div",bt,[r.message.content?(A(),P("div",Mt,oe(r.message.content),1)):le("",!0),r.message.image_url?(A(),P("div",Dt,[F("img",{src:r.message.image_url,alt:"Прикрепленное изображение",class:"uploaded-image",loading:"lazy"},null,8,wt)])):le("",!0)]),F("pre",null,oe(r.message.formattedTime),1)])]))}},Tt=me(_t,[["__scopeId","data-v-c96f350d"]]),Ot={class:"edit-form"},Ct=["value"],xt={__name:"MessageEditForm",props:{message:Object,editedContent:String},emits:["save","cancel","update-content"],setup(r,{emit:M}){return(S,c)=>(A(),P("div",Ot,[F("input",{value:r.editedContent,onInput:c[0]||(c[0]=a=>S.$emit("update-content",a.target.value)),placeholder:"Редактировать сообщение",onKeydown:c[1]||(c[1]=De(a=>S.$emit("save"),["enter"]))},null,40,Ct),F("button",{onClick:c[2]||(c[2]=a=>S.$emit("save"))},"Сохранить"),F("button",{onClick:c[3]||(c[3]=a=>S.$emit("cancel"))},"Отмена")]))}},It={__name:"MessagesList",props:{messages:Array,usernames:Object,avatars:Object,user:Object,editingMessageId:[Number,String],editedContent:String},emits:["scroll","start-edit","save-edit","cancel-edit","delete-message","update:edited-content"],setup(r,{expose:M,emit:S}){const c=V(null);M({scrollToBottom:()=>{c.value&&(c.value.scrollTop=c.value.scrollHeight)},adjustScrollPosition:o=>{c.value&&(c.value.scrollTop=c.value.scrollHeight-o)}});const $=S,h=o=>{$("update:edited-content",o)};return(o,w)=>(A(),P("div",{class:"messages",ref:"messagesContainer",onScroll:w[1]||(w[1]=D=>o.$emit("scroll",D))},[(A(!0),P(Te,null,Oe(r.messages,(D,u)=>{var d;return A(),P("div",{key:u,class:"message-container"},[r.editingMessageId===D.id?(A(),he(xt,{key:0,message:D,"edited-content":r.editedContent,onSave:v=>o.$emit("save-edit",D),onCancel:w[0]||(w[0]=v=>o.$emit("cancel-edit")),onUpdateContent:h},null,8,["message","edited-content","onSave"])):(A(),he(Tt,{key:1,message:D,username:r.usernames[D.sender_id],avatar:r.avatars[D.sender_id],"is-own-message":D.sender_id===((d=r.user)==null?void 0:d.id),onEdit:v=>o.$emit("start-edit",D),onDelete:v=>o.$emit("delete-message",D.id)},null,8,["message","username","avatar","is-own-message","onEdit","onDelete"]))])}),128))],544))}},kt={class:"message-input"},jt=["value"],Et={key:0,class:"preview-container"},Ut=["src"],Ht={__name:"MessageInput",props:{modelValue:String},emits:["update:modelValue","send"],setup(r,{emit:M}){const S=r,c=M,a=V(null),j=V(null),$=V(null),h=()=>{$.value.click()},o=u=>{const d=u.target.files[0];if(d){if(!d.type.startsWith("image/")){alert("Пожалуйста, выберите изображение");return}if(d.size>5*1024*1024){alert("Максимальный размер файла - 5MB");return}a.value=d,j.value=URL.createObjectURL(d)}},w=()=>{a.value=null,j.value=null,$.value.value=""},D=async()=>{try{let u=null;if(a.value){const d=a.value.name.split(".").pop(),v=`${Date.now()}_${Math.random().toString(36).substr(2,9)}.${d}`,{data:p,error:i}=await B.storage.from("chat_images").upload(`images/${v}`,a.value);if(i)throw i;const{data:y}=B.storage.from("chat_images").getPublicUrl(p.path);u=y.publicUrl}c("send",{text:S.modelValue,imageUrl:u}),a.value=null,j.value=null,$.value.value=""}catch(u){console.error("Ошибка загрузки файла:",u),alert("Ошибка при отправке изображения")}};return(u,d)=>(A(),P("div",kt,[F("input",{value:r.modelValue,onInput:d[0]||(d[0]=v=>u.$emit("update:modelValue",v.target.value)),placeholder:"Введите сообщение",onKeydown:De(D,["enter"])},null,40,jt),F("input",{type:"file",ref_key:"fileInput",ref:$,accept:"image/*",onChange:o,hidden:""},null,544),F("button",{onClick:h,class:"file-button"},"📷"),F("button",{class:"button",onClick:D},"Отправить"),a.value?(A(),P("div",Et,[F("img",{src:j.value,class:"image-preview"},null,8,Ut),F("button",{onClick:w,class:"remove-image-button"},"×")])):le("",!0)]))}},zt=me(Ht,[["__scopeId","data-v-1b0d4acc"]]),Lt={class:"content"},Yt=15,Nt={__name:"ChatsDetailsPage",setup(r){ne.extend(Ve),ne.extend(Be);const M=Ee(),S=Ce(),c=M.params.id,a=V([]),j=V(""),$=V({}),h=ve(()=>S.user),o=V({}),w=V(null),D=V(null),u=xe({activeDropdown:null,editingMessageId:null,editedContent:""}),d=e=>{u.editedContent=e},v=async()=>{try{const e=[...new Set(a.value.map(n=>n.sender_id))],{data:t}=await B.from("users").select("id, username, avatar_url").in("id",e);t.forEach(n=>{$.value[n.id]=n.username,o.value[n.id]=n.avatar_url})}catch(e){console.error("Ошибка загрузки данных пользователей:",e)}},p=async()=>{try{if(!u.editingMessageId)return;const e=a.value.find(n=>n.id===u.editingMessageId);if(!e||e.sender_id!==h.value.id)throw new Error("Unauthorized edit");const{error:t}=await B.from("messages").update({content:u.editedContent}).eq("id",u.editingMessageId);if(t)throw t;a.value=a.value.map(n=>n.id===u.editingMessageId?{...n,content:u.editedContent}:n),C()}catch(e){q(e)}},i=e=>{e.sender_id===h.value.id&&(u.editingMessageId=e.id,u.editedContent=e.content,u.activeDropdown=null)},y=C;function C(){u.editingMessageId=null,u.editedContent="",u.activeDropdown=null}const I=async()=>{try{let e=B.from("messages").select("*").eq("chat_id",c).order("created_at",{ascending:!1}).limit(Yt);D.value&&(e=e.lt("created_at",D.value));const{data:t,error:n}=await e;if(n)throw n;if(t.length>0){const s=w.value.$el,f=s.scrollHeight;a.value=[...t.reverse(),...a.value],await Ue(),s.scrollTop=s.scrollHeight-f}}catch(e){q(e)}};let _=null;const H=()=>{_||(_=B.channel("messages-channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`chat_id=eq.${c}`},x).subscribe(e=>{console.log("Subscription status:",e)}))},x=e=>{var t;switch(e.eventType){case"INSERT":new Date(e.new.created_at)>new Date((t=a.value[a.value.length-1])==null?void 0:t.created_at)&&(a.value=[...a.value,e.new]);break;case"UPDATE":a.value=a.value.map(n=>n.id===e.new.id?e.new:n);break;case"DELETE":a.value=a.value.filter(n=>n.id!==e.old.id);break}},g=()=>{const e=document.querySelector(".messages");e.scrollTop=e.scrollHeight},k=pt(e=>{e.target.scrollTop===0&&I()},200),U=async e=>{try{const t=e.text.trim(),n=e.imageUrl;if(!t&&!n)return;const s={id:Date.now().toString(),chat_id:c,sender_id:h.value.id,content:t,image_url:n,created_at:new Date().toISOString(),is_temp:!0};a.value=[...a.value,s];const{data:f,error:m}=await B.from("messages").insert([{chat_id:c,sender_id:h.value.id,content:t,image_url:n}]).select("*");if(m)throw m;g(),setTimeout(()=>g(),800),a.value=a.value.map(T=>T.is_temp?f[0]:T),j.value=""}catch(t){a.value=a.value.filter(n=>!n.is_temp),q(t)}},z=async e=>{try{const t=a.value.find(s=>s.id===e);if(!t||t.sender_id!==h.value.id)throw new Error("Unauthorized deletion");const{error:n}=await B.from("messages").delete().eq("id",e);if(n)throw n;a.value=a.value.filter(s=>s.id!==e)}catch(t){q(t)}},O=e=>{try{return ne.utc(e).local().format("HH:mm")}catch(t){return console.error("Time conversion error:",t),ne(e).format("HH:mm")}},b=ve(()=>a.value.map(e=>({...e,formattedTime:O(e.created_at)}))),q=e=>{console.error("Error:",e.message)},G=V(Date.now()),l=async()=>{document.visibilityState==="visible"&&Date.now()-G.value>3e4&&(await I(),await v()),G.value=Date.now()};return Ie(()=>a.value,async e=>{g(),e.length>0&&await v()},{deep:!0}),ke(async()=>{try{g(),document.addEventListener("visibilitychange",l),await I(),H()}catch(e){console.error("Ошибка инициализации:",e)}}),je(()=>{_&&B.removeChannel(_),document.removeEventListener("visibilitychange",l)}),(e,t)=>(A(),P("div",Lt,[ce(It,{ref_key:"messagesContainer",ref:w,messages:b.value,usernames:$.value,avatars:o.value,user:h.value,"editing-message-id":u.editingMessageId,"edited-content":u.editedContent,onScroll:ge(k),onStartEdit:i,onSaveEdit:p,onCancelEdit:ge(y),onDeleteMessage:z,"onUpdate:editedContent":d},null,8,["messages","usernames","avatars","user","editing-message-id","edited-content","onScroll","onCancelEdit"]),ce(zt,{modelValue:j.value,"onUpdate:modelValue":t[0]||(t[0]=n=>j.value=n),onSend:U},null,8,["modelValue"])]))}},Vt=me(Nt,[["__scopeId","data-v-a3789a0f"]]);export{Vt as default};
