import{e as S,Z as E,S as p,f as _,$ as d,d as b,G as j,c,I as A,j as x,B as f,o as m,l as w,a as I,b as T}from"./index-QomUHjFO.js";import{u as B}from"./errors-ptkwsH4S-CVFA_oyv.js";const k=j("changeUser ",()=>{const t=B(),o=E(),i=async(a,e)=>{const{error:r}=await c.from("users").update({avatar_url:e}).eq("id",a);if(o.avatar_url=e,r)throw new Error("Ошибка при обновлении URL аватара: "+r.message)},n=async(a,e)=>{try{const{data:r,error:s}=await c.from("users").update({birthdate:e}).eq("id",a);if(s)throw s;return r}catch(r){throw console.error("Ошибка при изменении даты рождения:",r),r}},l=async a=>{if(a.length<3)return t.setErrors("Имя пользователя должно содержать не менее 3 символов."),!1;const{data:e,error:r}=await c.from("users").select("username").eq("username",a);return r?(t.setErrors("Ошибка при проверке имени пользователя."),console.error("Ошибка при проверке имени пользователя:",r),!1):e.length>0?(t.setErrors("Имя пользователя уже занято."),!1):!0},u=a=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(a)?!0:(t.setErrors("Введите корректный адрес электронной почты."),!1),v=async(a,e)=>{const{data:r,error:s}=await c.from("users").select("username, friends");if(s){console.error("Ошибка при получении пользователей:",s);return}for(const g of r){const h=g.friends||[];if(h.includes(a)){const y=h.map($=>$===a?e:$),{error:U}=await c.from("users").update({friends:y}).eq("username",g.username);U&&console.error("Ошибка при обновлении списка друзей у пользователя:",U)}}};return{changeUsername:async(a,e)=>{if(!await l(e))return;const{data:r,error:s}=await c.from("users").update({username:e}).eq("username",a).select();if(console.log("то что пришло ",r[0]),s){t.setErrors("Ошибка при изменении имени пользователя"),console.error("Ошибка при изменении имени пользователя:",s);return}await v(a,e),t.clearErrors()},changeEmail:async(a,e)=>{if(!u(e))return;const{error:r}=await c.auth.updateUser({email:e});if(r){t.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",r);return}const{error:s}=await c.from("users").update({email:e}).eq("email",a).select();if(s){t.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",s);return}t.clearErrors()},updateAvatarUrl:i,changeBirthdate:n}}),C={key:0,alt:"Аватар",height:"100px",width:"100px",class:"avatar"},P={key:1,src:"https://kawdmbqsvrrmvhymflnx.supabase.co/storage/v1/object/public/avatars/avatars/default-avatar-icon-of-social-media-user-vector.jpg",alt:"Аватар",height:"100px",width:"100px",class:"avatar"},z={__name:"DisplayAvatar",setup(t){const o=E(),i=p(()=>o.avatar_url);return(n,l)=>{const u=A("lazy");return i.value?x((f(),d("img",C,null,512)),[[u,i.value]]):(f(),d("img",P))}}},D=S(z,[["__scopeId","data-v-a7274546"]]),G={__name:"AvatarUploader",setup(t){const o=E(),i=k(),n=p(()=>o.user_id);p(()=>o.status);const l=p(()=>o.avatar_url),u=_(null),v=e=>{u.value=e.target.files[0]},a=async()=>{try{if(l.value){const h=`avatars/${n.value}/${l.value.split("/").pop()}`,{error:y}=await c.storage.from("avatars").remove([h]);if(y)throw y}const e=`avatars/${n.value}/${u.value.name}`,{data:r,error:s}=await c.storage.from("avatars").upload(e,u.value,{upsert:!0});if(s)throw s;const g=`https://kawdmbqsvrrmvhymflnx.supabase.co/storage/v1/object/public/avatars/${r.path}`;await i.updateAvatarUrl(n.value,g),u.value=null}catch(e){console.error("Ошибка загрузки аватара:",e)}};return(e,r)=>(f(),d("div",null,[b(D),m("div",null,[m("input",{type:"file",onChange:v,accept:"image/*"},null,32),m("button",{onClick:a},"Загрузить аватар")])]))}},L={key:0},R=["type","name"],Z={style:{color:"red"}},q={__name:"EditableField",props:{label:String,value:String,inputType:String,name:String,error:String},emits:["save"],setup(t,{emit:o}){const i=o,n=_(!1),l=_(""),u=()=>{i("save",l.value),n.value=!1,l.value=""};return(v,a)=>(f(),d("div",null,[m("p",null,w(t.label)+": "+w(t.value?t.value:"Неизвестно"),1),m("button",{onClick:a[0]||(a[0]=e=>n.value=!n.value)},w(t.value?"Изменить":"Добавить"),1),n.value?(f(),d("div",L,[x(m("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>l.value=e),type:t.inputType,name:t.name},null,8,R),[[I,l.value]]),m("button",{onClick:u},"Сохранить")])):T("",!0),m("pre",Z,w(t.error),1)]))}},M={__name:"PersonalProfilePage",setup(t){const o=E(),i=k(),n=p(()=>o.user_id),l=p(()=>o.username),u=p(()=>o.birthdate),v=_(""),a=async r=>{try{await i.changeUsername(l.value,r)}catch(s){v.value=s.message}},e=async r=>{try{await i.changeBirthdate(n.value,r)}catch(s){v.value=s.message}};return(r,s)=>(f(),d("section",null,[b(G),b(q,{label:"Никнейм",value:l.value,inputType:"text",name:"username",error:v.value,onSave:a},null,8,["value","error"]),b(q,{label:"Дата рождения",value:u.value,inputType:"date",name:"birthdate",error:v.value,onSave:e},null,8,["value","error"])]))}};export{M as default};
