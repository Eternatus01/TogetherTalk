import{f as D,u as w,s as v,_ as S,r as f,c as _,e as y,a as b,b as u,d as m,t as g,h as I,D as B,i as V,y as q,z as U,x as z}from"./index-EqbG0gcO.js";import{_ as P}from"./DisplayAvatar-PGygWKn0.js";import{u as F}from"./errors-BaeMetFA.js";const k=D("changeUser ",()=>{const a=F(),t=w(),d=async e=>{const{error:r}=await v.from("users").update({avatar_url:e}).eq("id",t.user.id);if(t.user.avatar_url=e,r)throw new Error("Ошибка при обновлении URL аватара: "+r.message)},s=async e=>{try{const r=new Date(e).toISOString(),{data:l,error:i}=await v.from("users").update({birthdate:r}).eq("id",t.user.id).select().single();if(i)throw i;return t.updateUserState({...t.user,birthdate:r}),l}catch(r){throw console.error("Ошибка при изменении даты рождения:",r),r}},o=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?!0:(a.setErrors("Введите корректный адрес электронной почты."),!1);return{changeUsername:async e=>{try{const r=t.user.username,{data:l,error:i}=await v.from("users").update({username:e}).eq("id",t.user.id);if(i)throw i;const{error:c}=await v.from("posts").update({username:e}).eq("user_id",t.user.id);if(c)throw c;t.user.username=e,a.clearErrors()}catch(r){a.setErrors(r.message||"Ошибка при изменении имени"),console.error("Ошибка:",r)}},changeEmail:async(e,r)=>{if(!o(r))return;const{error:l}=await v.auth.updateUser({email:r});if(l){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",l);return}const{error:i}=await v.from("users").update({email:r}).eq("email",e).select();if(i){a.setErrors("Ошибка при изменении почты пользователя"),console.error("Ошибка при изменении почты пользователя:",i);return}a.clearErrors()},updateAvatarUrl:d,changeBirthdate:s}}),T={__name:"AvatarUploader",props:{size:{type:Number,default:12}},setup(a){const t=w(),d=k(),s=f(null),o=_(()=>t.user.id),p=_(()=>t.avatar_url),n=f(null),e=()=>{s.value.click()},r=async c=>{n.value=c.target.files[0],n.value&&await i()},l=a,i=async()=>{try{if(!n.value)return;if(p.value){const C=`avatars/${o.value}/${p.value.split("/").pop()}`,{error:E}=await v.storage.from("avatars").remove([C]);if(E)throw E}const c=`avatars/${o.value}/${n.value.name}`,{data:h,error:A}=await v.storage.from("avatars").upload(c,n.value,{upsert:!0});if(A)throw A;const x=`https://kawdmbqsvrrmvhymflnx.supabase.co/storage/v1/object/public/avatars/${h.path}`;await d.updateAvatarUrl(x),s.value.value="",n.value=null}catch(c){console.error("Ошибка загрузки аватара:",c)}};return(c,h)=>(y(),b("div",null,[u("div",{onClick:e,class:"avatar-wrapper"},[m(P,{size:l.size},null,8,["size"]),h[0]||(h[0]=u("div",{class:"hover-overlay"},[u("svg",{class:"camera-icon",viewBox:"0 0 24 24"},[u("path",{fill:"currentColor",d:"M4,4H7L9,2H15L17,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M12,7A5,5 0 0,0 7,12A5,5 0 0,0 12,17A5,5 0 0,0 17,12A5,5 0 0,0 12,7M12,9A3,3 0 0,1 15,12A3,3 0 0,1 12,15A3,3 0 0,1 9,12A3,3 0 0,1 12,9Z"})])],-1)),u("input",{type:"file",ref_key:"fileInput",ref:s,onChange:r,accept:"image/*",class:"hidden-input"},null,544)])]))}},H=S(T,[["__scopeId","data-v-76c17073"]]),M={key:0},N=["type","name"],L={__name:"EditableField",props:{label:String,value:String,inputType:String,name:String,error:String},emits:["save"],setup(a,{emit:t}){const d=t,s=f(!1),o=f(""),p=()=>{d("save",o.value),s.value=!1,o.value=""};return(n,e)=>(y(),b("div",null,[u("p",null,g(a.label)+": "+g(a.value?a.value:"Неизвестно"),1),u("button",{onClick:e[0]||(e[0]=r=>s.value=!s.value)},g(a.value?"Изменить":"Добавить"),1),s.value?(y(),b("div",M,[I(u("input",{"onUpdate:modelValue":e[1]||(e[1]=r=>o.value=r),type:a.inputType,name:a.name},null,8,N),[[B,o.value]]),u("button",{onClick:p},"Сохранить")])):V("",!0),u("pre",null,g(a.error),1)]))}},$=S(L,[["__scopeId","data-v-dacfbfbd"]]),O={class:"setting"},j={__name:"SettingsPage",setup(a){const t=w(),d=k(),s=_(()=>t.user||{}),o=f(""),p=_(()=>{var n;return(n=s.value)!=null&&n.birthdate?new Date(s.value.birthdate).toISOString().split("T")[0]:""});return(n,e)=>{const r=z("router-link");return y(),b("section",O,[m(r,{to:`/profile/${s.value.username}`},{default:q(()=>e[2]||(e[2]=[u("span",{class:"material-icons"},"назад в профиль",-1)])),_:1},8,["to"]),m(H,{size:50}),m($,{label:"Никнейм",value:s.value.username,inputType:"text",name:"username",error:o.value,onSave:e[0]||(e[0]=l=>U(d).changeUsername(l))},null,8,["value","error"]),m($,{label:"Дата рождения",value:p.value,inputType:"date",name:"birthdate",error:o.value,onSave:e[1]||(e[1]=l=>U(d).changeBirthdate(l))},null,8,["value","error"])])}}},J=S(j,[["__scopeId","data-v-6c27d427"]]);export{J as default};
